<!DOCTYPE html>
<html>

<head>
    <title>Color coding designer</title>
    <style>
        body {
            width: 95%;
            height: 100%;
            position: absolute;
            z-index: -4;
        }

        #vis-area {
            z-index: -3;
            position: relative;
            margin: auto;
            width: 90%;
            height: 50%;
            background-color: red;
        }

        #color-space {
            border: 1px solid black;
            width: 100%;
            height: 100%;

            padding: 0px;
            margin: 0px;
            z-index: -1;
            position: absolute;
        }

        #color-space-svg {
            padding: 0px;
            margin: 0px;
        }

        .label {
            z-index: 0;
            position: absolute;
            background: rgba(255, 255, 255, 0.45);
            color: black;
            font-family: monospace;
            padding: 3px;
            border-radius: 8px;

            transform-origin: 0 0;
            transform: rotate(45deg);
            cursor: grab;
        }

        .label span {
            display: block;
            max-width: 12em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dragged {
            cursor: grabbing !important;
        }

        .marker {
            border: 2px solid white;
            border-radius: 8px;
            width: 8px;
            height: 8px;
            background-color: none;
            position: absolute;
            top: -6px;
            left: -6px;
        }

        #label-list {
            position: relative;
            width: 75%;
            margin: 1em auto 0em auto;
        }

        #label-list .label-form {
            position: relative;
            display: inline-block;
            width: auto;
            border-radius: 0.5em;
            padding: 1px;
            margin: 5px 2px;
            background-color: blanchedalmond;
        }

        #control-bar {
            width: 65%;
            clear: both;
            margin: auto;
        }

        input {
            height: 2em;
            margin: 0px 0px 0px 1em;
            vertical-align: middle;
        }

        input[type="text"] {
            border: 0px;
            border-radius: 0.5em;
            margin: 0px 1em;
            background-color: white;
            color: black;
            font-family: monospace;
            padding: 2px 0.75em;
            width: 12em;
        }

        input[type="button"] {
            margin-right: 0.5em;
        }
    </style>
    <script type="text/javascript">
        // https://stackoverflow.com/questions/1740700/how-to-get-hex-color-value-rather-than-rgb-value
        function rgb2hex(rgb) {
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            function hex(x) {
                return ("0" + parseInt(x).toString(16)).slice(-2);
            }
            return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
        }
        function dragElement(el, labelId) {
            // https://www.w3schools.com/howto/howto_js_draggable.asp
            var posX = 0, poxY = 0, startX = 0, startY = 0;
            el.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                startX = e.clientX;
                startY = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                el.classList.add("dragged");
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                posX = startX - e.clientX;
                poxY = startY - e.clientY;
                startX = e.clientX;
                startY = e.clientY;
                el.style.top = ((el.offsetTop - poxY) * 100 / el.parentElement.clientHeight) + "%";
                el.style.left = ((el.offsetLeft - posX) * 100 / el.parentElement.clientWidth) + "%";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                el.classList.remove("dragged");

                if (el.offsetLeft < -25 || el.offsetLeft > el.parentElement.clientWidth
                    || el.offsetTop < -25 || el.offsetTop > el.parentElement.clientHeight) {
                    deleteLabel(labelId);
                }
            }
        }

        function rgbToHsl(r, g, b) {
            // https://www.niwa.nu/2013/05/math-behind-colorspace-conversions-rgb-hsl/
            // https://stackoverflow.com/questions/39118528/rgb-to-hsl-conversion
            var R = r / 255;
            var G = g / 255;
            var B = b / 255;
            var min = Math.min(R, G, B);
            var max = Math.max(R, G, B);

            var lum = (min + max) / 2;

            var sat = 0;
            var hue = 0;
            if (min != max) {
                if (lum <= 0.5) {
                    sat = (max - min) / (max + min);
                } else {
                    sat = (max - min) / (2 - max - min);
                }

                var C = max - min;
                if (R == max) {
                    hue = (G - B) / C;
                } else if (G == max) {
                    hue = 2.0 + (B - R) / C;
                } else if (B == max) {
                    hue = 4.0 + (R - G) / C;
                }
                hue *= 60;
            }

            if (hue < 0) {
                hue += 360;
            }

            var r = Object();
            r.lum = lum * 100;
            r.sat = sat * 100;
            r.hue = hue;
            return r;
        }

        function synchronizedValues(label) {
            var dummy = document.createElement("div");

            var inputText = label.form.querySelector("input[type=text]");
            inputText.addEventListener("input", textChanged);

            var inputColor = label.form.querySelector("input[type=color]");
            inputColor.addEventListener("input", colorSet);

            var inputDelete = label.form.querySelector("input[type=button][value=Delete]");
            inputDelete.onclick = deleteLabel;

            var observer = new MutationObserver(function (mutations) {
                labelMoved();
            });
            observer.observe(label.div, { attributes: true, attributeFilter: ['style'] });

            labelMoved();

            function textChanged(e) {
                label.div.getElementsByTagName("span")[0].textContent = e.target.value;
            }
            function labelMoved() {
                var hue = 360 * (label.div.offsetLeft / label.div.parentElement.clientWidth);
                var lum = 5 + 90 * (label.div.offsetTop / label.div.parentElement.clientHeight);
                var hsl = "hsl(" + hue + ", 100%, " + lum + "%)";
                dummy.style.color = hsl;
                inputColor.value = rgb2hex(dummy.style.color);
            }
            function colorSet(e) {
                var hex = e.target.value;
                var r = parseInt(hex.substring(1, 3), 16);
                var g = parseInt(hex.substring(3, 5), 16);
                var b = parseInt(hex.substring(5, 7), 16);
                var hsl = rgbToHsl(r, g, b);
                label.div.style.left = (100 * hsl.hue / 360) + "%";
                label.div.style.top = (100 * (Math.min(Math.max(hsl.lum, 5), 95) - 5) / 90) + "%";
                e.preventDefault();
            }
            function deleteLabel(e) {
                label.div.remove();
                label.form.remove();
                delete labels[label.id];
                e.preventDefault();
            }
        }

        function makeSvg(tag) {
            return document.createElementNS('http://www.w3.org/2000/svg', tag);
        }

        function makeGradient(hue) {
            var g = makeSvg('linearGradient');
            g.setAttribute("id", "g" + hue);
            g.setAttribute("x1", "0%");
            g.setAttribute("x2", "0%");
            g.setAttribute("y1", "0%");
            g.setAttribute("y2", "100%");
            for (var i = 0; i < 5; ++i) {
                var percent = (i * 25) + "%";
                var lum = (5 + i * 18) + "%";
                var s = makeSvg('stop');
                s.setAttribute("offset", percent);
                s.setAttribute("style", "stop-color:hsl(" + hue + ", 100%, " + lum + ");stop-opacity:1");
                g.appendChild(s);
            }
            return g;
        }

        function makeRect(hue) {
            var r = makeSvg('rect');
            var w = 100 / 360;
            r.setAttribute("x", hue * w + "%");
            r.setAttribute("y", 0 + "%");
            r.setAttribute("width", w * 1.5 + "%");
            r.setAttribute("height", "100%");
            r.setAttribute("fill", "url(#g" + hue + ")");
            return r;
        }

        var idSequence = 0;
        var labels = Array();
        function makeLabelDiv(text) {
            var marker = document.createElement("div");
            marker.classList.add("marker");
            var s0 = document.createElement("span");
            s0.textContent = text;
            var d0 = document.createElement("div");
            d0.classList.add("label");
            d0.appendChild(marker);
            d0.append(s0);
            d0.style.top = (60 - Math.random() * 20) + "%";
            d0.style.left = (60 - Math.random() * 20) + "%";
            return d0;
        }

        function makeLabelForm(id, text) {
            var fs = document.createElement("fieldset");
            fs.classList.add("label-form");
            var inColor = document.createElement("input");
            inColor.setAttribute("type", "color");
            inColor.setAttribute("name", "col-" + id);
            fs.appendChild(inColor);

            var inText = document.createElement("input");
            inText.setAttribute("type", "text");
            inText.setAttribute("name", "txt-" + id);
            inText.setAttribute("value", text);
            inText.classList.add("label-name");
            fs.appendChild(inText);

            var inDelete = document.createElement("input");
            inDelete.setAttribute("type", "button");
            inDelete.setAttribute("value", "Delete");
            inDelete.setAttribute("name", "del-" + id);
            fs.appendChild(inDelete);
            return fs;
        }

        function addLabel() {
            var id = idSequence++;
            var placeholder = 'Label#' + id;
            var d = makeLabelDiv(placeholder);
            dragElement(d, id);

            var f = makeLabelForm(id, placeholder);

            var label = Object();
            label.id = id;
            label.div = d;
            label.form = f;
            labels[id] = label;

            document.getElementById("vis-area").appendChild(d);
            document.getElementById("label-list").appendChild(f);

            synchronizedValues(label);
        }

        function deleteLabel(id) {
            var label = labels[id];
            label.div.remove();
            label.form.remove();
            delete labels[label.id];
        }

        function sortByHue() {
            var references = Array();
            for (var label of labels) {
                label.form.remove();
                references.push({ 'id': label.id, 'x': label.div.offsetLeft, 'y': label.div.offsetTop });
            }
            references.sort(function (lhs, rhs) {
                if (lhs.x == rhs.x && lhs.y == rhs.y)
                    return 0;
                if (lhs.x == rhs.x)
                    return lhs.y < rhs.y ? -1 : 1;
                return lhs.x < rhs.x ? -1 : 1;
            });
            for (var ref of references) {
                document.getElementById("label-list").appendChild(labels[ref.id].form);
            }
        }

        window.addEventListener("load", function () {
            var svg = document.getElementById('color-space-svg');

            for (var label of document.getElementsByClassName("label"))
                dragElement(label);

            var defs = svg.getElementsByTagName("defs")[0];
            for (var i = 0; i < 360; ++i) {
                defs.appendChild(makeGradient(i));
            }

            for (var i = 0; i < 360; ++i) {
                svg.appendChild(makeRect(i));
            }
            document.getElementById("add-button").onclick = function (e) { addLabel(); };
            document.getElementById("sort-button").onclick = sortByHue;

            addLabel();
            addLabel();

            addLabel();
        });

    </script>
</head>

<body>
    <div id="vis-area">
        <div id="color-space">
            <svg id="color-space-svg" width='100%' height='100%' viewBox="0 0 720 200" preserveAspectRatio="none">
                <defs></defs>
            </svg>
        </div>
    </div>
    <form id="label-list">
        <fieldset id="control-bar">
            <input type="button" name="add-button" id="add-button" value="Add" />
            <input type="button" name="sort-button" id="sort-button" value="Sort" />
            <input type="button" name="sort-button" id="sort-button" value="Load" />
            <input type="button" name="sort-button" id="sort-button" value="Save" />
        </fieldset>
    </form>
</body>

</html>